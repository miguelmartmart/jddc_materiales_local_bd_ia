# üöÄ DEVIA - Sistema Gen√©rico de Gesti√≥n & Inteligencia Artificial

**Documento T√©cnico de Referencia**

Prompt de desarrollo: "Act√∫a como un experto en desarrollo software, e inteligencia artificial. quiero crear diferentes aplicaciones entorno a una base de datos para que a partir de un modelo de inteligencia artifical, poder hacerle preguntas al modelo sobre los datos de la base de datos. adem√°s, realizar diferentes pantallas de la aplicaci√≥n web, para gestionar la informaci√≥n de la base de datos, sacar estad√≠sticas etc. adem√°s, quiero que los usuarios de la aplicaci√≥n, puedan configurar sencillamente sus prompts, con diferentes tipos de abstracci√≥n, y dificultad, teniendo en cuenta que habr√° usuarios con muchos conocimientos y otros sin ninguno. quiero que crear toda la estructura gen√©rica para diferentes bases de datos y tipos de estructuras. adem√°s, que se sigan todos los patrones de dise√±o, y principios de desarrollo software, de calidad, robustez, usabilidad, abstracci√≥n, seguridad, orientaci√≥n a objetos, multihilo, escalabilidad, refactorizaci√≥n, etc.... ficheros de 500 l√≠neas como mucho, ficheros de constantes, de par√°metros, todo ultra organizado en carpetas, ficheros descriptivos, eficiente, eficaz, etc quiero que este proyecto tenga su propio archivo DEVIA.MD esquem√°tico eficiente y super √∫til. utiliza el fichero DEVIA_GESTION_ARTICULOS.md para hacerte una idea de c√≥mo hacerlo, ya que en concreto, aunque deba ser gen√©rico, ha de funcionar para la conexi√≥n a la base de datos que describe."

---

## üìã √çNDICE R√ÅPIDO

1. [Arquitectura del Sistema](#arquitectura)
2. [Estructura de Archivos](#estructura)
3. [Patrones de Dise√±o](#patrones)
4. [Gu√≠as de Desarrollo](#guias)
5. [Configuraci√≥n](#configuracion)
6. [Extensibilidad](#extensibilidad)

---

## üèóÔ∏è ARQUITECTURA DEL SISTEMA {#arquitectura}

El sistema sigue una arquitectura en capas estricta para garantizar desacoplamiento y escalabilidad.

```mermaid
graph TD
    Client[Cliente Web (SPA)] --> API[API Gateway (FastAPI)]
    API --> Core[N√∫cleo del Sistema]
    
    subgraph "N√∫cleo (Core)"
        Auth[Gestor de Autenticaci√≥n]
        PromptMgr[Gestor de Prompts]
        AIMgr[Gestor de IA]
        DBMgr[Gestor de Base de Datos]
    end
    
    subgraph "Capa de Abstracci√≥n (Drivers)"
        AIDriver[Drivers IA]
        DBDriver[Drivers BD]
    end
    
    AIMgr --> AIDriver
    DBMgr --> DBDriver
    
    AIDriver --> Gemini[Google Gemini]
    AIDriver --> OpenAI[OpenAI GPT]
    AIDriver --> Groq[Groq Llama]
    
    DBDriver --> Firebird[Firebird SQL]
    DBDriver --> Postgres[PostgreSQL]
    DBDriver --> MySQL[MySQL]
```

---

## üìÅ ESTRUCTURA DE ARCHIVOS {#estructura}

Todo el c√≥digo debe estar ultra-organizado. M√°ximo 500 l√≠neas por fichero.

```
/
‚îú‚îÄ‚îÄ backend/
‚îÇ   ‚îú‚îÄ‚îÄ core/                          # L√≥gica central del sistema
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ abstract/                  # Clases base abstractas (Interfaces)
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ai.py                  # Interface para proveedores de IA
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ database.py            # Interface para drivers de BD
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ config/                    # ‚öôÔ∏è CONFIGURACI√ìN CENTRALIZADA
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ settings.py            # Variables de entorno (.env)
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ai_models_config.json  # ü§ñ Modelos IA disponibles
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ db_metadata_optimized.json  # üìä METADATOS BD REALES
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ database_metadata.py   # Wrapper de metadatos (usa JSON)
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ metadata_manager.py    # Gestor de metadatos sem√°nticos
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ model_manager.py       # Gestor de modelos IA
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ factory/                   # F√°bricas de objetos
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ai_factory.py          # Factory para proveedores IA
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ db_factory.py          # Factory para drivers BD
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ utils/                     # Utilidades generales
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ constants.py           # üîß CONSTANTES DEL SISTEMA
‚îÇ   ‚îú‚îÄ‚îÄ drivers/                       # Implementaciones espec√≠ficas
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ai/                        # Drivers de IA
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ gemini_driver.py       # Google Gemini
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ groq_driver.py         # Groq (Llama)
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ openai_compatible_driver.py  # OpenAI/OpenRouter
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ db/                        # Drivers de BD
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ firebird_driver.py     # Firebird SQL
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ firebird_queries.py    # Queries espec√≠ficas Firebird
‚îÇ   ‚îú‚îÄ‚îÄ modules/                       # M√≥dulos de negocio
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chat/                      # üí¨ CHAT CON IA (Text-to-SQL)
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ router.py              # Endpoints FastAPI
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ service.py             # üß† L√≥gica de chat y SQL
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ models/                    # Gesti√≥n de modelos IA
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ router.py              # CRUD de modelos
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ prompts/                   # Gesti√≥n de prompts
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ router.py              # CRUD de prompts
‚îÇ   ‚îú‚îÄ‚îÄ scripts/                       # üõ†Ô∏è Scripts de utilidad
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ extract_db_metadata.py     # Extracci√≥n autom√°tica de esquema
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ diagnose_schema.py         # Diagn√≥stico de conexi√≥n BD
‚îÇ   ‚îî‚îÄ‚îÄ main.py                        # üöÄ Punto de entrada API
‚îÇ
‚îú‚îÄ‚îÄ frontend/
‚îÇ   ‚îú‚îÄ‚îÄ assets/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ css/                       # Estilos modulares
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ base.css               # Estilos base
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ components.css         # Componentes UI
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ js/                        # L√≥gica de cliente
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ core/                  # Framework ligero propio
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ api.js             # Cliente HTTP
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ constants.js       # Constantes frontend
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ router.js          # Enrutador SPA
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ modules/               # L√≥gica por pantalla
‚îÇ   ‚îÇ           ‚îú‚îÄ‚îÄ chat.js            # üí¨ Interfaz de chat
‚îÇ   ‚îÇ           ‚îî‚îÄ‚îÄ models.js          # Gesti√≥n de modelos
‚îÇ   ‚îî‚îÄ‚îÄ index.html                     # SPA Entry Point
‚îÇ
‚îú‚îÄ‚îÄ .env                               # üîê SECRETOS (API Keys, DB creds)
‚îú‚îÄ‚îÄ .env.example                       # Plantilla de .env
‚îú‚îÄ‚îÄ .gitignore                         # Archivos ignorados por Git
‚îú‚îÄ‚îÄ DEVIA.MD                           # üìñ Este archivo
‚îú‚îÄ‚îÄ README.md                          # Documentaci√≥n general
‚îî‚îÄ‚îÄ start_system.bat                   # Script de inicio (Windows)
```

### üìå Archivos Clave para Modificar

| Archivo | Prop√≥sito | Cu√°ndo Modificar |
|---------|-----------|------------------|
| `backend/core/config/db_metadata_optimized.json` | **Esquema de BD real** | Al cambiar tablas/columnas en la BD |
| `backend/core/config/ai_models_config.json` | Modelos IA disponibles | Al a√±adir/quitar modelos IA |
| `backend/core/utils/constants.py` | Constantes del sistema | Al a√±adir nuevas constantes |
| `backend/modules/chat/service.py` | L√≥gica Text-to-SQL | Al cambiar prompts o l√≥gica de chat |
| `.env` | API Keys y credenciales | Al cambiar claves o BD |


---

## üß© PATRONES DE DISE√ëO {#patrones}

Se aplican estrictamente los siguientes patrones para asegurar robustez:

1.  **Factory Method**: Para la creaci√≥n de conexiones a BD y proveedores de IA.
    *   `DBFactory.get_connection("firebird")`
    *   `AIFactory.get_provider("gemini")`
2.  **Strategy**: Para intercambiar algoritmos de procesamiento o proveedores en tiempo de ejecuci√≥n.
3.  **Singleton**: Para gestores de configuraci√≥n y pools de conexiones.
4.  **Repository**: Para abstraer el acceso a datos de la l√≥gica de negocio.
5.  **Dependency Injection**: Inyecci√≥n de dependencias en los servicios para facilitar testing.

---

## üìè GU√çAS DE DESARROLLO {#guias}

> [!IMPORTANT]
> **Reglas de Oro**
> 1.  **Max 500 l√≠neas**: Si un archivo pasa de 500 l√≠neas, se refactoriza y divide.
> 2.  **Documentaci√≥n**: Todo m√©todo p√∫blico debe tener DocString.
> 3.  **Tipado**: Uso estricto de Type Hints en Python.
> 4.  **Constantes**: No usar "n√∫meros m√°gicos" ni strings sueltos. Todo a ficheros de constantes.

### Est√°ndar de C√≥digo (Python)
```python
class DatabaseDriver(ABC):
    """Clase base para drivers de base de datos."""
    
    @abstractmethod
    def connect(self, config: DBConfig) -> Connection:
        """Establece conexi√≥n con la base de datos."""
        pass
```

---

## ‚öôÔ∏è CONFIGURACI√ìN {#configuracion}

El sistema es altamente configurable mediante archivos JSON y variables de entorno.

### `ai_config.json`
```json
{
  "default_provider": "gemini",
  "providers": {
    "gemini": {
      "api_key": "ENV_GEMINI_KEY",
      "model": "gemini-1.5-pro"
    }
  }
}
```

### `prompts_config.json`
Permite definir niveles de complejidad para los usuarios.
```json
{
  "levels": {
    "beginner": {
      "abstraction": "high",
      "ui_mode": "wizard"
    },
    "expert": {
      "abstraction": "none",
      "ui_mode": "raw_json"
    }
  }
}
```

---

## üóÑÔ∏è SISTEMA DE METADATOS DE BASE DE DATOS {#metadatos}

El sistema incluye un gestor inteligente de metadatos que optimiza las consultas a la IA.

### Arquitectura de Metadatos

```mermaid
graph LR
    DB[(Base de Datos<br/>Firebird)] -->|Extracci√≥n| Script[extract_db_metadata.py]
    Script -->|Genera| Full[db_metadata_full.json]
    Script -->|Genera| Opt[db_metadata_optimized.json]
    Opt -->|Carga| Manager[MetadataManager]
    Manager -->|√çndices| Search[B√∫squeda R√°pida]
    Manager -->|Esquema| AI[Prompt para IA]
```

### Componentes del Sistema

#### 1. **Extractor de Metadatos** (`backend/scripts/extract_db_metadata.py`)
Script que se ejecuta una vez para extraer toda la informaci√≥n de la BD:
- Tablas y columnas con tipos de datos
- Primary Keys y Foreign Keys
- Conteo de registros por tabla
- Clasificaci√≥n autom√°tica por categor√≠as

**Uso:**
```bash
python backend/scripts/extract_db_metadata.py
```

**Salida:**
- `db_metadata_full.json`: Metadatos completos (para referencia)
- `db_metadata_optimized.json`: Versi√≥n ligera para IA (solo esencial)

#### 2. **Gestor de Metadatos** (`backend/core/config/metadata_manager.py`)
Clase que gestiona los metadatos en memoria con b√∫squeda optimizada:

```python
from backend.core.config.metadata_manager import get_metadata_manager

manager = get_metadata_manager()

# Buscar tablas por concepto
tables = manager.find_tables_by_concept("productos")  # ‚Üí ['ARTICULO']

# Generar esquema enfocado seg√∫n pregunta
schema = manager.get_focused_schema("cu√°ntos productos hay?")

# Obtener estad√≠sticas
stats = manager.get_statistics()
```

#### 3. **Metadatos Sem√°nticos** (`backend/core/config/database_metadata.py`)
Mapeo manual de conceptos de negocio a tablas reales:

```python
DATABASE_METADATA = {
    "ARTICULO": {
        "descripcion": "Productos/art√≠culos del inventario",
        "conceptos": ["productos", "art√≠culos", "items"],
        "columnas_clave": {
            "CODIGO": "C√≥digo √∫nico",
            "NOMBRE": "Nombre del producto",
            "PVPIVA": "Precio con IVA"
        }
    }
}
```

### Optimizaci√≥n para IA

El sistema env√≠a a la IA **solo la informaci√≥n relevante**:

1. **Detecci√≥n de contexto**: Analiza la pregunta del usuario
2. **Filtrado inteligente**: Solo incluye tablas relacionadas
3. **L√≠mite de columnas**: M√°ximo 15 columnas por tabla
4. **Priorizaci√≥n**: Tablas con m√°s registros primero

**Ejemplo:**
- Pregunta: "cu√°ntos productos hay?"
- Esquema enviado: Solo tabla ARTICULO (no todas las 436 tablas)
- Tokens ahorrados: ~90%

### Categor√≠as de Tablas

El sistema clasifica autom√°ticamente las tablas:
- `productos`: ARTICULO, PRODUCTO, ITEM
- `clientes`: CLIENTE, CUSTOMER
- `ventas`: FACTURA, INVOICE, VENTA
- `proveedores`: PROVEEDOR, SUPPLIER
- `compras`: PEDIDO, ORDER, COMPRA
- `inventario`: STOCK, ALMACEN
- `usuarios`: USUARIO, USER, EMPLEADO
- `configuracion`: CONFIG, PARAM, SETTING
- `otros`: Resto de tablas

### Actualizaci√≥n de Metadatos

Para actualizar los metadatos cuando cambia la estructura de la BD:

```bash
# 1. Re-ejecutar extractor
python backend/scripts/extract_db_metadata.py

# 2. El sistema recarga autom√°ticamente en el siguiente reinicio
```

> [!TIP]
> **Rendimiento**: Los metadatos se cargan una vez al inicio y se mantienen en memoria.
> No hay consultas a la BD en cada pregunta del usuario.

---

## üöÄ EXTENSIBILIDAD {#extensibilidad}

### A√±adir una nueva Base de Datos
1.  Crear `backend/drivers/db/new_db_driver.py`.
2.  Heredar de `DatabaseDriver`.
3.  Implementar m√©todos requeridos.
4.  Registrar en `DBFactory`.

### A√±adir un nuevo M√≥dulo
1.  Crear carpeta en `backend/modules/nuevo_modulo`.
2.  Definir rutas en `router.py`.
3.  Implementar servicios y repositorios.
4.  A√±adir UI en `frontend/assets/js/modules/nuevo_modulo.js`.

---

## üõ†Ô∏è ESTADO ACTUAL DEL PROYECTO (Noviembre 2025)

### ‚úÖ Funcionalidades Implementadas
1.  **Backend Unificado**: Servidor FastAPI (`backend/main.py`) sirviendo API y Frontend est√°tico.
2.  **Gesti√≥n de Modelos IA**:
    *   Soporte para **OpenAI, Google Gemini, Groq, OpenRouter**.
    *   Configuraci√≥n din√°mica v√≠a UI y `.env`.
    *   Sistema de "Drivers" para estandarizar la comunicaci√≥n con diferentes proveedores.
3.  **Chat con Base de Datos (Text-to-SQL)**:
    *   Conversi√≥n de lenguaje natural a SQL (Firebird 2.5).
    *   **Sistema de Metadatos Sem√°nticos**: `database_metadata.py` mapea conceptos de negocio (e.g., "ventas") a tablas reales (`CAB_FACT_VENTA`).
    *   **Prompt Engineering Avanzado**: Instrucciones estrictas para evitar alucinaciones y forzar formato JSON/SQL.
4.  **Seguridad**:
    *   Gesti√≥n de secretos v√≠a `.env` (API Keys, credenciales BD).
    *   Sanitizaci√≥n de logs (truncado de claves).

### üöß En Progreso / Pendiente
1.  **Validaci√≥n de Esquema BD**:
    *   Ajuste fino de nombres de tablas/columnas (`CAB_FACT_VENTA`, `PVP`) basado en feedback de errores reales.
    *   Script de extracci√≥n autom√°tica de metadatos (`extract_db_metadata.py`) pendiente de depuraci√≥n de conexi√≥n.
2.  **Mejoras de UI**:
    *   Visualizaci√≥n de tablas de datos m√°s rica en el chat.
    *   Historial de conversaciones persistente.

### üìù Notas de Configuraci√≥n
*   **Base de Datos**: Firebird 2.5.
*   **Conexi√≥n**: Se usa `firebirdsql` (driver puro Python).
*   **Metadatos**: Definidos manualmente en `backend/core/config/database_metadata.py` para garantizar precisi√≥n sem√°ntica.

---

## üîÑ FLUJO DE CHAT (Text-to-SQL)

1.  **Usuario**: Env√≠a pregunta (e.g., "¬øProductos m√°s caros?").
2.  **ChatService**:
    *   Carga configuraci√≥n del modelo seleccionado.
    *   Recupera el **Esquema Sem√°ntico** (`get_semantic_schema()`).
    *   Construye el **System Prompt** con instrucciones estrictas y el esquema.
3.  **IA**: Genera consulta SQL (e.g., `SELECT FIRST 10 ...`).
4.  **ChatService**:
    *   Detecta bloque ` ```sql `.
    *   Ejecuta la consulta contra Firebird.
    *   Recibe resultados (lista de diccionarios).
5.  **ChatService**:
    *   Construye un segundo prompt con la pregunta original + SQL ejecutado + Resultados.
    *   Solicita a la IA una **Interpretaci√≥n** en lenguaje natural (con reglas estrictas: Euros, Objetividad).
6.  **Usuario**: Recibe la respuesta interpretada.
