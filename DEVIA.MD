# üöÄ DEVIA - Sistema Gen√©rico de Gesti√≥n & Inteligencia Artificial

**Documento T√©cnico de Referencia**

Prompt de desarrollo: "Act√∫a como un experto en desarrollo software, e inteligencia artificial. quiero crear diferentes aplicaciones entorno a una base de datos para que a partir de un modelo de inteligencia artifical, poder hacerle preguntas al modelo sobre los datos de la base de datos. adem√°s, realizar diferentes pantallas de la aplicaci√≥n web, para gestionar la informaci√≥n de la base de datos, sacar estad√≠sticas etc. adem√°s, quiero que los usuarios de la aplicaci√≥n, puedan configurar sencillamente sus prompts, con diferentes tipos de abstracci√≥n, y dificultad, teniendo en cuenta que habr√° usuarios con muchos conocimientos y otros sin ninguno. quiero que crear toda la estructura gen√©rica para diferentes bases de datos y tipos de estructuras. adem√°s, que se sigan todos los patrones de dise√±o, y principios de desarrollo software, de calidad, robustez, usabilidad, abstracci√≥n, seguridad, orientaci√≥n a objetos, multihilo, escalabilidad, refactorizaci√≥n, etc.... ficheros de 500 l√≠neas como mucho, ficheros de constantes, de par√°metros, todo ultra organizado en carpetas, ficheros descriptivos, eficiente, eficaz, etc quiero que este proyecto tenga su propio archivo DEVIA.MD esquem√°tico eficiente y super √∫til. utiliza el fichero DEVIA_GESTION_ARTICULOS.md para hacerte una idea de c√≥mo hacerlo, ya que en concreto, aunque deba ser gen√©rico, ha de funcionar para la conexi√≥n a la base de datos que describe."

---

## üìã √çNDICE R√ÅPIDO

1. [Arquitectura del Sistema](#arquitectura)
2. [Estructura de Archivos](#estructura)
3. [Patrones de Dise√±o](#patrones)
4. [Gu√≠as de Desarrollo](#guias)
5. [Configuraci√≥n](#configuracion)
6. [Extensibilidad](#extensibilidad)

---

## üèóÔ∏è ARQUITECTURA DEL SISTEMA {#arquitectura}

El sistema sigue una arquitectura en capas estricta para garantizar desacoplamiento y escalabilidad.

```mermaid
graph TD
    Client[Cliente Web (SPA)] --> API[API Gateway (FastAPI)]
    API --> Core[N√∫cleo del Sistema]
    
    subgraph "N√∫cleo (Core)"
        Auth[Gestor de Autenticaci√≥n]
        PromptMgr[Gestor de Prompts]
        AIMgr[Gestor de IA]
        DBMgr[Gestor de Base de Datos]
    end
    
    subgraph "Capa de Abstracci√≥n (Drivers)"
        AIDriver[Drivers IA]
        DBDriver[Drivers BD]
    end
    
    AIMgr --> AIDriver
    DBMgr --> DBDriver
    
    AIDriver --> Gemini[Google Gemini]
    AIDriver --> OpenAI[OpenAI GPT]
    AIDriver --> Groq[Groq Llama]
    
    DBDriver --> Firebird[Firebird SQL]
    DBDriver --> Postgres[PostgreSQL]
    DBDriver --> MySQL[MySQL]
```

---

## üìÅ ESTRUCTURA DE ARCHIVOS {#estructura}

Todo el c√≥digo debe estar ultra-organizado. M√°ximo 500 l√≠neas por fichero.

```
/
‚îú‚îÄ‚îÄ backend/
‚îÇ   ‚îú‚îÄ‚îÄ core/                   # L√≥gica central del sistema
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ abstract/           # Clases base abstractas (Interfaces)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ config/             # Gesti√≥n de configuraci√≥n
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ factory/            # F√°bricas de objetos
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ utils/              # Utilidades generales
‚îÇ   ‚îú‚îÄ‚îÄ drivers/                # Implementaciones espec√≠ficas
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ai/                 # Drivers de IA (Gemini, Groq...)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ db/                 # Drivers de BD (Firebird, Postgres...)
‚îÇ   ‚îú‚îÄ‚îÄ modules/                # M√≥dulos de negocio
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ articles/           # Gesti√≥n de Art√≠culos (Ejemplo)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ prompts/            # Gesti√≥n de Prompts
‚îÇ   ‚îî‚îÄ‚îÄ main.py                 # Punto de entrada API
‚îÇ
‚îú‚îÄ‚îÄ frontend/
‚îÇ   ‚îú‚îÄ‚îÄ assets/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ css/                # Estilos modulares
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ js/                 # L√≥gica de cliente
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ core/           # Framework ligero propio
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ modules/        # L√≥gica por pantalla
‚îÇ   ‚îî‚îÄ‚îÄ index.html              # SPA Entry Point
‚îÇ
‚îú‚îÄ‚îÄ docs/                       # Documentaci√≥n
‚îÇ   ‚îî‚îÄ‚îÄ DEVIA.MD                # Este archivo
‚îÇ
‚îî‚îÄ‚îÄ config/                     # Archivos de configuraci√≥n externos
    ‚îú‚îÄ‚îÄ ai_config.json
    ‚îî‚îÄ‚îÄ db_config.json
```

---

## üß© PATRONES DE DISE√ëO {#patrones}

Se aplican estrictamente los siguientes patrones para asegurar robustez:

1.  **Factory Method**: Para la creaci√≥n de conexiones a BD y proveedores de IA.
    *   `DBFactory.get_connection("firebird")`
    *   `AIFactory.get_provider("gemini")`
2.  **Strategy**: Para intercambiar algoritmos de procesamiento o proveedores en tiempo de ejecuci√≥n.
3.  **Singleton**: Para gestores de configuraci√≥n y pools de conexiones.
4.  **Repository**: Para abstraer el acceso a datos de la l√≥gica de negocio.
5.  **Dependency Injection**: Inyecci√≥n de dependencias en los servicios para facilitar testing.

---

## üìè GU√çAS DE DESARROLLO {#guias}

> [!IMPORTANT]
> **Reglas de Oro**
> 1.  **Max 500 l√≠neas**: Si un archivo pasa de 500 l√≠neas, se refactoriza y divide.
> 2.  **Documentaci√≥n**: Todo m√©todo p√∫blico debe tener DocString.
> 3.  **Tipado**: Uso estricto de Type Hints en Python.
> 4.  **Constantes**: No usar "n√∫meros m√°gicos" ni strings sueltos. Todo a ficheros de constantes.

### Est√°ndar de C√≥digo (Python)
```python
class DatabaseDriver(ABC):
    """Clase base para drivers de base de datos."""
    
    @abstractmethod
    def connect(self, config: DBConfig) -> Connection:
        """Establece conexi√≥n con la base de datos."""
        pass
```

---

## ‚öôÔ∏è CONFIGURACI√ìN {#configuracion}

El sistema es altamente configurable mediante archivos JSON y variables de entorno.

### `ai_config.json`
```json
{
  "default_provider": "gemini",
  "providers": {
    "gemini": {
      "api_key": "ENV_GEMINI_KEY",
      "model": "gemini-1.5-pro"
    }
  }
}
```

### `prompts_config.json`
Permite definir niveles de complejidad para los usuarios.
```json
{
  "levels": {
    "beginner": {
      "abstraction": "high",
      "ui_mode": "wizard"
    },
    "expert": {
      "abstraction": "none",
      "ui_mode": "raw_json"
    }
  }
}
```

---

## üóÑÔ∏è SISTEMA DE METADATOS DE BASE DE DATOS {#metadatos}

El sistema incluye un gestor inteligente de metadatos que optimiza las consultas a la IA.

### Arquitectura de Metadatos

```mermaid
graph LR
    DB[(Base de Datos<br/>Firebird)] -->|Extracci√≥n| Script[extract_db_metadata.py]
    Script -->|Genera| Full[db_metadata_full.json]
    Script -->|Genera| Opt[db_metadata_optimized.json]
    Opt -->|Carga| Manager[MetadataManager]
    Manager -->|√çndices| Search[B√∫squeda R√°pida]
    Manager -->|Esquema| AI[Prompt para IA]
```

### Componentes del Sistema

#### 1. **Extractor de Metadatos** (`backend/scripts/extract_db_metadata.py`)
Script que se ejecuta una vez para extraer toda la informaci√≥n de la BD:
- Tablas y columnas con tipos de datos
- Primary Keys y Foreign Keys
- Conteo de registros por tabla
- Clasificaci√≥n autom√°tica por categor√≠as

**Uso:**
```bash
python backend/scripts/extract_db_metadata.py
```

**Salida:**
- `db_metadata_full.json`: Metadatos completos (para referencia)
- `db_metadata_optimized.json`: Versi√≥n ligera para IA (solo esencial)

#### 2. **Gestor de Metadatos** (`backend/core/config/metadata_manager.py`)
Clase que gestiona los metadatos en memoria con b√∫squeda optimizada:

```python
from backend.core.config.metadata_manager import get_metadata_manager

manager = get_metadata_manager()

# Buscar tablas por concepto
tables = manager.find_tables_by_concept("productos")  # ‚Üí ['ARTICULO']

# Generar esquema enfocado seg√∫n pregunta
schema = manager.get_focused_schema("cu√°ntos productos hay?")

# Obtener estad√≠sticas
stats = manager.get_statistics()
```

#### 3. **Metadatos Sem√°nticos** (`backend/core/config/database_metadata.py`)
Mapeo manual de conceptos de negocio a tablas reales:

```python
DATABASE_METADATA = {
    "ARTICULO": {
        "descripcion": "Productos/art√≠culos del inventario",
        "conceptos": ["productos", "art√≠culos", "items"],
        "columnas_clave": {
            "CODIGO": "C√≥digo √∫nico",
            "NOMBRE": "Nombre del producto",
            "PVPIVA": "Precio con IVA"
        }
    }
}
```

### Optimizaci√≥n para IA

El sistema env√≠a a la IA **solo la informaci√≥n relevante**:

1. **Detecci√≥n de contexto**: Analiza la pregunta del usuario
2. **Filtrado inteligente**: Solo incluye tablas relacionadas
3. **L√≠mite de columnas**: M√°ximo 15 columnas por tabla
4. **Priorizaci√≥n**: Tablas con m√°s registros primero

**Ejemplo:**
- Pregunta: "cu√°ntos productos hay?"
- Esquema enviado: Solo tabla ARTICULO (no todas las 436 tablas)
- Tokens ahorrados: ~90%

### Categor√≠as de Tablas

El sistema clasifica autom√°ticamente las tablas:
- `productos`: ARTICULO, PRODUCTO, ITEM
- `clientes`: CLIENTE, CUSTOMER
- `ventas`: FACTURA, INVOICE, VENTA
- `proveedores`: PROVEEDOR, SUPPLIER
- `compras`: PEDIDO, ORDER, COMPRA
- `inventario`: STOCK, ALMACEN
- `usuarios`: USUARIO, USER, EMPLEADO
- `configuracion`: CONFIG, PARAM, SETTING
- `otros`: Resto de tablas

### Actualizaci√≥n de Metadatos

Para actualizar los metadatos cuando cambia la estructura de la BD:

```bash
# 1. Re-ejecutar extractor
python backend/scripts/extract_db_metadata.py

# 2. El sistema recarga autom√°ticamente en el siguiente reinicio
```

> [!TIP]
> **Rendimiento**: Los metadatos se cargan una vez al inicio y se mantienen en memoria.
> No hay consultas a la BD en cada pregunta del usuario.

---

## üöÄ EXTENSIBILIDAD {#extensibilidad}

### A√±adir una nueva Base de Datos
1.  Crear `backend/drivers/db/new_db_driver.py`.
2.  Heredar de `DatabaseDriver`.
3.  Implementar m√©todos requeridos.
4.  Registrar en `DBFactory`.

### A√±adir un nuevo M√≥dulo
1.  Crear carpeta en `backend/modules/nuevo_modulo`.
2.  Definir rutas en `router.py`.
3.  Implementar servicios y repositorios.
4.  A√±adir UI en `frontend/assets/js/modules/nuevo_modulo.js`.
